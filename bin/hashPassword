#!/bin/env php
<?php

use Y2KaoZ\PhpAuth\PasswordAuthentication;

require_once(__DIR__ . "/../vendor/autoload.php");

define('BACKSPACE', chr(8));
define('ERASE_TO_END_OF_LINE', "\033[0K");

function readPassword(): string
{
  $password = "";
  readline_callback_handler_install("", fn() => null);
  while (true) {
    $keystroke = stream_get_contents(STDIN, 1);
    if ($keystroke === false) {
      die("Unable to get the stream contents.");
    }
    $ascii = ord($keystroke);
    if ($ascii < 33 || $ascii > 127) {
      break;
    } else {
      if ($ascii === 127) {
        $password = substr($password, 0, -1);
        fwrite(STDOUT, BACKSPACE);
        fwrite(STDOUT, ERASE_TO_END_OF_LINE);
      } else {
        $password .= $keystroke;
        fwrite(STDOUT, "*");
      }
    }
  }
  return $password;
}

echo "Write a password (leave blank to generate one):\n";
$password = trim(readPassword());
$display = false;
if (empty($password)) {
  $display = true;
  $password = PasswordAuthentication::GenerateRandomPassword();
}
if ($display) {
  echo "\npassword:\n" . $password;
}
$hash = password_hash($password, PASSWORD_DEFAULT);
if (password_verify($password, $hash)) {
  echo "\nhash:\n$hash\n";
} else {
  "invalid hash.\n";
}
return $hash;
